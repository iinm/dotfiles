#!/usr/bin/env bash

set -eu -o pipefail

this_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
app_root="$(cd "$this_dir/.." && pwd)"

# Install dependencies
if ! test -f "$app_root/dist/index.js"; then
  (
    set -e
    cd "$app_root"
    npm install
    npm run build
  )
fi

export NODE_OPTIONS="--disable-warning=DEP0040"
export NODE_ENV=${NODE_ENV:-production}

# Run the agent
if test "$NODE_ENV" = "development"; then
  exec "$app_root/env.sh" node "$app_root/node_modules/.bin/tsx" "$app_root/src/index.ts" "$@"
fi
exec "$app_root/env.sh" node --enable-source-maps "$app_root/dist/index.js" "$@"
