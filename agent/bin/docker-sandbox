#!/usr/bin/env bash

set -eu -o pipefail

script_name="$(basename "${BASH_SOURCE[0]}")"

help() {
  cat << HELP
Usage: $script_name --dockerfile FILE
           [--allow-write] [--allow-net|--allow-net-host-only]
           [--volume DIR] [--tty] [--verbose]
           COMMAND

Execute a command within a container defined by a Dockerfile.

  --dockerfile FILE      (Required) Path to the Dockerfile.
  --allow-write          Enable write access to the project root directory inside the container.
                         (By default, the project root is mounted read-only.)
  --allow-net            Allow full network access for the container.
  --allow-net-host-only  Allow network access only to the host machine (via a dedicated bridge network).
  --volume DIR           Mount a named volume for the specified host directory.
                         The volume will be mounted at the absolute path of DIR inside the container.
  --tty                  Allocate a pseudo-TTY for the container.
  --verbose              Output verbose logs to stderr.

Examples:
  $script_name --dockerfile ./Dockerfile.sandbox --verbose --tty bash
  $script_name --dockerfile ./Dockerfile.sandbox --allow-write --allow-net --volume node_module npm install
  $script_name --dockerfile ./Dockerfile.sandbox --allow-net-host-only wget -O - host.docker.internal:8000 
HELP
}

verbose="no"
dockerfile=""
allow_write="no"
allow_net="no"
volumes=()
allocate_tty="no"

while test "$#" -gt 0; do
  case "$1" in
    --help                ) help; exit 0 ;;
    --dockerfile          ) dockerfile="$2"; shift 2 ;;
    --verbose             ) verbose="yes"; shift ;;
    --allow-write         ) allow_write="yes"; shift ;;
    --allow-net           ) allow_net="yes"; shift ;;
    --allow-net-host-only ) allow_net="host_only"; shift ;;
    --tty                 ) allocate_tty="yes"; shift ;;
    --volume              ) volumes+=("$2"); shift 2 ;;
    --*                   ) echo "Error: unknown option: $1" >&2; exit 1 ;;
    *                     ) break ;;
  esac
done

# validate arguments
if test -z "$dockerfile"; then
  echo "Error: --dockerfile is required" >&2
  help >&2
  exit 1
fi

if test "$#" -eq 0; then
  echo "Error: COMMAND is required" >&2
  help >&2
  exit 1
fi

# save stdout, stderr
exec {stdout}>&1
exec {stderr}>&2

if test "$verbose" = "no"; then
  # discard stderr
  exec 2> /dev/null
fi
# stdout to stderr
exec 1>&2

# set options
image_name="agent-sandbox--$(basename "$(pwd)")"
image_tag="latest"
docker_run_opts=(
  --rm
  --interactive
  --workdir "$(pwd)"
  --add-host host.docker.internal:host-gateway
)

project_root="$(git rev-parse --show-toplevel || pwd)"
if test "$allow_write" = "yes"; then
  docker_run_opts+=(--volume "${project_root}:${project_root}")
else
  docker_run_opts+=(--volume "${project_root}:${project_root}:ro")
fi

host_only_network_name="${image_name}--host-only"
if test "$allow_net" = "yes"; then
  :
elif test "$allow_net" = "host_only"; then
  docker_run_opts+=(--net "$host_only_network_name")
else
  docker_run_opts+=(--net none)
fi

if test "$allocate_tty" = "yes"; then
  docker_run_opts+=(--tty)
fi

for volume in "${volumes[@]}"; do
  volume_name="$(basename "$(pwd)")--${volume//\//-}"
  mount_path="$(readlink -f "${volume}")"
  docker_run_opts+=(--volume "${volume_name}:${mount_path}")
  if test "$(uname)" = "Linux"; then
    docker run --rm -v "${volume_name}:/mnt" busybox:latest chown "$(id -u):$(id -g)" /mnt
  fi
done

if test "$(uname)" = "Linux"; then
  docker_run_opts+=(--user "$(id -u):$(id -g)")
fi

log() {
  now="$(date "+%Y-%m-%d %H:%M:%S")"
  echo -e "$now" "$@"
}

on_exit() {
  local exit_status="$?"

  if test "$verbose" = "no"; then
    exec 2> /dev/null
  fi
  exec 1>&2

  if docker network inspect "$host_only_network_name" &> /dev/null; then
    log "Remove host network"
    docker network rm "$host_only_network_name"
  fi

  return "$exit_status"
}

trap 'on_exit' EXIT

log "$(cat << EOF
Sandbox Configurations:
  dockerfile=${dockerfile}
  image_name=${image_name}
  image_tag=${image_tag}
  docker_run_opts=${docker_run_opts[@]}
  command=$@
EOF
)"

log "Build docker image"
# shellcheck disable=SC2068
if ! docker build --tag "${image_name}:${image_tag}" - < "$dockerfile"; then
  log "Error: failed to build image"
  exit 1
fi

if test "$allow_net" = "host_only"; then
  log "Create host-only network"
  docker network create "$host_only_network_name" --driver bridge \
    -o com.docker.network.bridge.enable_ip_masquerade=false
fi

# restore stdout, stderr
exec 2>&${stderr} {stderr}>&-
exec 1>&${stdout} {stdout}>&-

# shellcheck disable=SC2068
docker run ${docker_run_opts[@]} "${image_name}:${image_tag}" $@
